# 工艺分解功能说明

## 功能概述

根据合同参数以及装箱单详情生成每个箱包的工艺工件分解表。包括

1. 列出箱包内部件以及部件的所有子部件的列表，列出所需的数量，是否外购
2. 可以导出整个装箱单所有箱包的所有部件统计表，也就是箱包工艺分解表的汇总表
3. 支持箱包分解状态管理，区分已分解和未分解的箱包

## 功能流程

### 搜索选择合同

工艺分解界面上搜索合同号或者项目号，选择合同进行工艺分解

### 选择箱包进行分解

在弹出界面选择箱包，根据箱包状态显示不同的操作按钮：
- **未分解箱包（status=0）**：显示"工艺分解"按钮
- **已分解箱包（status=1）**：显示"重新分解"、"查看分解表"、"删除分解表"按钮

### 工艺分解过程

1. **递归查找子部件**：根据该箱包部件表的内容，去components表中匹配component_No
2. **递归处理**：如果能找到，则记录下来这个component作为分解表中的部件。然后根据components_relationship表的关联内容递归查找所有子部件
3. **防循环引用**：使用访问记录防止循环引用问题
4. **问题部件处理**：如果在上述步骤中找不到匹配项，记录为问题部件，写在备注中
5. **部件合并**：如果有同一个component_no的部件，认为是同种部件，合并计算数量
6. **状态更新**：分解完成后，将箱包状态设置为已分解（status=1）

### 分解表显示

- **扁平化显示**：所有父部件和子部件都显示在同一个列表中
- **按需加载**：只有在点击"查看分解表"时才加载分解数据
- **实时状态**：根据箱包状态动态显示相应的操作按钮

### 生成导出工艺分解汇总

1. 生成所有箱包的工艺分解并且导出汇总表，同一个component_no的部件合并计算数量
2. 支持单个箱包分解表导出和整个合同汇总表导出

## 技术实现

### 数据库设计

- **containers表**：新增status字段（0=未分解，1=已分解）
- **container_components_breakdown表**：存储分解结果
- **递归查询**：通过components_relationship表实现父子关系查询

### 后端实现

- **BreakdownServiceImpl**：核心分解逻辑
  - `processComponent`：处理单个部件
  - `processChildComponentsRecursively`：递归处理子部件
  - `getContainerBreakdown`：获取分解结果
  - `breakdownContainer`：执行分解并更新状态
  - `deleteContainerBreakdown`：删除分解并重置状态

### 前端实现

- **动态按钮显示**：根据container.status条件渲染不同按钮
- **懒加载**：分解数据按需获取，提高页面加载性能
- **状态同步**：操作完成后实时更新UI状态

## 数据流程

1. **选择合同** → 加载箱包列表（包含status信息）
2. **点击分解** → 后端递归处理 → 保存分解结果 → 更新status=1
3. **查看分解表** → 按需加载分解数据 → 前端显示
4. **删除分解** → 删除分解记录 → 重置status=0
5. **导出功能** → 生成汇总数据 → 下载CSV文件

